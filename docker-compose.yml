version: '3.9'

services:
  # Backend API Service (Node.js)
  api:
    build: .
    container_name: mcd-hrms-api
    ports:
      - "8010:8010"
    environment:
      - PORT=8010
      - NODE_ENV=production
      - API_KEY=${API_KEY:-hackathon-demo-key}
      - ALLOWED_ORIGINS=http://localhost:8001,http://localhost:8010,http://localhost:8002,http://ml-service:8002
      - DOTENV_CONFIG_PATH=.env.local
      - ML_SERVICE_URL=http://ml-service:8002
    volumes:
      - ./server/data:/app/server/data
      - ./logs:/app/logs
    networks:
      - mcd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8010/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ML/NLP Service (Python FastAPI)
  ml-service:
    build: ./ml_service
    container_name: mcd-hrms-ml
    ports:
      - "8002:8002"
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-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}
      - PYTHONUNBUFFERED=1
    networks:
      - mcd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend Service (Vite Dev Server)
  frontend:
    image: node:20-slim
    container_name: mcd-hrms-frontend
    working_dir: /app
    volumes:
      - ./:/app
      - frontend_node_modules:/app/node_modules
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0 --port 8001"]
    ports:
      - "8001:8001"
    environment:
      - VITE_API_URL=http://localhost:8010
      - VITE_ML_SERVICE_URL=http://localhost:8002
      - VITE_API_KEY=${API_KEY:-hackathon-demo-key}
      - VITE_OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - VITE_TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - VITE_TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - VITE_TWILIO_WHATSAPP_NUMBER=${TWILIO_WHATSAPP_NUMBER}
    depends_on:
      - api
      - ml-service
    networks:
      - mcd-network
    restart: unless-stopped

networks:
  mcd-network:
    driver: bridge

volumes:
  frontend_node_modules:
